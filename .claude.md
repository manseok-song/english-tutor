# AntiGravity - AI English Tutor for CEOs

> 운전 중인 40대 경영자를 위한 초저지연 AI 비즈니스 영어 튜터 PWA

## 프로젝트 개요

AntiGravity는 바쁜 테크 스타트업 CEO를 위한 핸즈프리/아이즈프리 영어 학습 앱입니다.
Gemini Multimodal Live API를 활용하여 실시간 음성 대화를 제공합니다.

## 기술 스택

- **Frontend**: React 18 + TypeScript + Vite 5
- **Audio**: Web Audio API (AudioWorklet + ScriptProcessorNode 폴백)
- **Network**: WebSocket (Gemini Multimodal Live API)
- **AI Model**: Gemini 2.0 Flash (`gemini-2.0-flash-exp`)
- **Storage**: IndexedDB (대화 기록)
- **PWA**: Service Worker + Web App Manifest

## 프로젝트 구조

```
src/
├── main.tsx                    # 앱 엔트리 포인트
├── App.tsx                     # 메인 앱 컴포넌트 (상태 관리)
├── components/
│   ├── ParticleCanvas.tsx      # Canvas 기반 파티클 애니메이션
│   ├── StatusIndicator.tsx     # 연결/음성 상태 표시
│   ├── ControlButton.tsx       # 녹음 시작/중지 버튼
│   ├── ApiKeyInput.tsx         # Gemini API 키 입력 UI
│   ├── TranscriptOverlay.tsx   # AI 응답 텍스트 표시
│   └── index.ts                # 컴포넌트 barrel export
├── services/
│   ├── AudioService.ts         # AudioWorklet 기반 오디오 처리 + VAD
│   ├── GeminiService.ts        # WebSocket 클라이언트 (강화된 에러 처리)
│   └── ConversationHistoryService.ts  # IndexedDB 대화 기록 저장
├── hooks/
│   ├── useAudio.ts             # 오디오 상태 관리 훅 (VAD, 재생 진폭 지원)
│   └── useGemini.ts            # Gemini 연결 상태 관리 훅
├── types/
│   └── index.ts                # TypeScript 타입 정의 및 상수
└── styles/
    └── global.css              # 글로벌 CSS 변수 및 스타일

public/
├── audio-worklet-processor.js  # AudioWorklet 프로세서 (별도 스레드)
├── manifest.webmanifest        # PWA 매니페스트
├── sw.js                       # Service Worker
└── favicon.svg                 # 앱 아이콘
```

## 핵심 아키텍처

### 1. 오디오 처리 파이프라인 (AudioWorklet 기반)

```
마이크 → MediaStream → AudioWorkletNode → VAD 분석 → PCM16 변환 → WebSocket 전송
         (메인 스레드)    (별도 스레드)     (음성 감지)                  ↓
스피커 ← AudioBuffer ← Float32 변환 ← PCM16 디코딩 ← Base64 디코딩 ← WebSocket 수신
```

- **입력**: 16kHz, Mono, PCM16 (Gemini 요구 사항)
- **출력**: 24kHz, Mono, PCM16 (Gemini 응답 형식)
- **VAD**: Voice Activity Detection - 음성 감지 시에만 전송

### 2. VAD (Voice Activity Detection)

```javascript
// AudioWorklet 내부에서 처리
vadThreshold: 0.015      // 음성 감지 임계값 (RMS)
silenceThreshold: 25     // 침묵 판정 프레임 수 (~0.5초)
```

- 실시간 RMS 계산으로 음성 활동 감지
- 음성 감지 시에만 Gemini로 오디오 전송 (대역폭 절약)
- 메인 스레드 블로킹 없이 별도 스레드에서 처리

### 3. 에러 처리 시스템

```typescript
GeminiErrorType:
  | 'API_KEY_INVALID'     // API 키 오류 (재시도 불가)
  | 'API_KEY_MISSING'     // API 키 누락
  | 'NETWORK_ERROR'       // 네트워크 오류 (재시도 가능)
  | 'CONNECTION_TIMEOUT'  // 연결 타임아웃 (15초)
  | 'RATE_LIMIT'          // 요청 한도 초과
  | 'SERVER_ERROR'        // 서버 오류
  | 'WEBSOCKET_ERROR'     // WebSocket 오류
  | 'UNKNOWN'             // 알 수 없는 오류
```

- 지수 백오프 재연결 (1초, 2초, 4초, 8초, 16초)
- 최대 5회 재연결 시도
- 에러 타입별 사용자 친화적 메시지 및 재시도 버튼

### 4. 상태 머신

```
VoiceState: idle → listening → processing → speaking → idle
                                    ↓
                                  error
```

- **idle**: 대기 중 (파란색 파티클)
- **listening**: 마이크 활성화 (초록색 파티클, 마이크 진폭 반응)
- **processing**: AI 처리 중 (노란색 파티클)
- **speaking**: AI 응답 재생 중 (보라색 파티클, 재생 진폭 반응)
- **error**: 오류 발생 (빨간색 파티클)

### 5. 대화 기록 (IndexedDB)

```typescript
// 세션 구조
ConversationSession {
  id: string
  startTime: number
  endTime?: number
  messageCount: number
}

// 메시지 구조
ConversationMessage {
  id: string
  sessionId: string
  role: 'user' | 'assistant'
  content: string
  timestamp: number
}
```

## 주요 상수 (`src/types/index.ts`)

```typescript
GEMINI_WS_URL: 'wss://generativelanguage.googleapis.com/ws/...'
GEMINI_MODEL: 'gemini-2.0-flash-exp'
INPUT_SAMPLE_RATE: 16000   // 마이크 입력
OUTPUT_SAMPLE_RATE: 24000  // 스피커 출력
BUFFER_SIZE: 4096          // 오디오 버퍼
PARTICLE_COUNT: 60         // 파티클 개수
RECONNECT_MAX_ATTEMPTS: 5  // 최대 재연결 시도
PING_INTERVAL: 25000       // 연결 유지 핑 간격 (ms)
```

## 개발 가이드라인

### 코드 스타일

- TypeScript strict 모드 사용
- 함수형 컴포넌트 + React Hooks 패턴
- 싱글톤 서비스 패턴 (`audioService`, `geminiService`, `conversationHistoryService`)
- 한글 주석 허용 (타겟 사용자가 한국인)

### AudioWorklet 주의사항

- `public/audio-worklet-processor.js`는 별도 파일로 유지 (번들링 불가)
- Worklet은 메인 스레드와 `postMessage`로 통신
- Safari 14.1 미만에서는 ScriptProcessorNode로 자동 폴백

### 브라우저 호환성

- **필수**: Safari iOS 17+, Chrome 최신
- Web Audio API: `webkitAudioContext` 폴백 포함
- iOS Safari에서 `AudioContext.resume()` 필수
- AudioWorklet: Safari 14.1+ 지원

### 보안 주의사항

- API 키는 `localStorage`에만 저장 (외부 전송 없음)
- HTTPS 필수 (마이크 접근 정책)
- API 키를 git에 커밋하지 말 것

## 실행 방법

```bash
# 의존성 설치
npm install

# 개발 서버 (http://localhost:3000)
npm run dev

# 프로덕션 빌드
npm run build

# 빌드 미리보기
npm run preview
```

## PWA 설치 (iOS)

1. Safari에서 앱 URL 접속
2. 공유 버튼 → "홈 화면에 추가"
3. 전체화면 앱으로 실행됨

## 트러블슈팅

### 마이크 권한 오류

- HTTPS 환경에서만 `getUserMedia` 사용 가능
- 개발 시 `localhost`는 예외

### iOS 오디오 자동재생 차단

- 사용자 제스처(탭) 후 `AudioContext.resume()` 호출
- `ControlButton` 클릭 시 자동으로 처리됨

### AudioWorklet 로드 실패

- CORS 정책으로 인해 로컬 파일에서 실행 불가
- 반드시 HTTP 서버에서 실행 (`npm run dev`)
- 실패 시 ScriptProcessorNode로 자동 폴백

### WebSocket 연결 실패

- API 키 확인 (39자 이상)
- 네트워크 상태 확인
- 자동 재연결 로직 (최대 5회, 지수 백오프)

### 대화 기록이 저장되지 않음

- IndexedDB 지원 여부 확인
- 시크릿 모드에서는 저장 제한될 수 있음

## 향후 개선 사항

- [ ] 차량 충전 감지 자동 실행 (iOS Shortcuts 연동)
- [ ] 오프라인 모드 지원
- [ ] 대화 기록 UI (히스토리 보기)
- [ ] 다국어 지원

## 라이선스

© 2024 AntiGravity Project. Powered by Gemini.
